# `analyze-api-client.js` — API Client Usage Analyzer

A **Node.js** script that inspects a generated OpenAPI client (the kind produced by tools such as `openapi-typescript-codegen`) and produces three structured **markdown reports**:

| Report file | Contents |
|---|---|
| `summary.md` | High-level overview — total/used/unused counts, per-service table, full endpoint listing |
| `used-endpoints.md` | Every used endpoint with all call-site locations (file path + line number + snippet) |
| `unused-endpoints.md` | Every endpoint defined in the client but never called in the codebase |

---

## Prerequisites

- **Node.js ≥ 14** (no additional `npm install` required — only built-in modules used)
- The target API client directory must contain a `services/` sub-folder with `.ts` or `.js` service files generated by `openapi-typescript-codegen` or a compatible tool.

---

## Usage

Run from the **project root**:

```bash
node scripts/analyze-api-client/analyze-api-client.js <api-client-path> [options]
```

### Arguments

| Argument | Description |
|---|---|
| `<api-client-path>` | Path to the generated API client directory. Accepts absolute or relative paths (resolved from the current working directory). The directory must contain a `services/` sub-folder. |

### Options

| Option | Default | Description |
|---|---|---|
| `--search-dirs=<dirs>` | `src` | Comma-separated list of directories (relative to the project root) in which to search for endpoint usages. |
| `--extensions=<exts>` | `.ts,.tsx,.js,.jsx` | Comma-separated file extensions to include in the usage search. |
| `--output=<dir>` | `reports/api-client-analysis` | Output directory for the generated markdown files (relative to project root). A sub-folder named after the API client is automatically created inside. |
| `--stdout` | — | Print the reports to stdout instead of saving them. Useful for piping or quick inspection. |
| `--quiet`, `-q` | — | Suppress all progress output to the console. |
| `--help`, `-h` | — | Print the help message and exit. |

---

## Examples

### Analyse the route-management client (default options)

```bash
node scripts/analyze-api-client/analyze-api-client.js generated/api-clients/route-management
```

Reports are saved to `reports/api-client-analysis/route-management/`.

---

### Analyse the user-management client

```bash
node scripts/analyze-api-client/analyze-api-client.js generated/api-clients/user-management
```

Reports are saved to `reports/api-client-analysis/user-management/`.

---

### Custom output directory

```bash
node scripts/analyze-api-client/analyze-api-client.js generated/api-clients/route-management \
  --output=docs/api-analysis
```

---

### Also search a `pages/` directory

```bash
node scripts/analyze-api-client/analyze-api-client.js generated/api-clients/route-management \
  --search-dirs=src,pages
```

---

### Print results to stdout (no files written)

```bash
node scripts/analyze-api-client/analyze-api-client.js generated/api-clients/route-management \
  --stdout --quiet
```

---

### Absolute path to a client outside the project root

```bash
node scripts/analyze-api-client/analyze-api-client.js /absolute/path/to/my-api-client \
  --search-dirs=src \
  --output=reports/my-api-analysis
```

---

## Output Structure

Running against `generated/api-clients/route-management` (with default options) produces:

```
reports/
└── api-client-analysis/
    └── route-management/
        ├── summary.md          ← overall statistics + full endpoint table
        ├── used-endpoints.md   ← used endpoints with call-site details
        └── unused-endpoints.md ← unused endpoints grouped by service
```

---

## How It Works

1. **Parse** — All `.ts` / `.js` files inside `<api-client-path>/services/` are read.  
   Each `public static <methodName>` declaration is extracted along with the  
   nearest `method: 'HTTP_VERB'` and `url: '/api/path'` values found inside the  
   same function body.

2. **Search** — Every source file inside the configured `--search-dirs` directories  
   is scanned line-by-line for calls matching  
   `ServiceClassName.methodName(` (or bare `methodName(` in files that import the  
   service). Files inside the API client directory itself are excluded to avoid  
   self-matches.

3. **Report** — Three markdown files are written (or printed to stdout) summarising  
   the findings.

---

## Reusability

The script is designed to work with **any** generated OpenAPI client that follows the standard `services/` layout. Pass a different `<api-client-path>` to analyse another client:

```bash
# ticketing-management client
node scripts/analyze-api-client/analyze-api-client.js generated/api-clients/ticketing-management

# location-tracking client
node scripts/analyze-api-client/analyze-api-client.js generated/api-clients/location-tracking
```

---

## Limitations

- **Dynamic calls** — If an endpoint is called via a dynamic reference (e.g., stored in a variable before calling), the script may not detect that usage.
- **Aliased imports** — If a service class is imported under a completely different name (e.g., `import { BusManagementService as BMS } from …`), only calls using the alias might be missed if the original class name does not appear in the file at all.
- The script treats any line that contains both the service class name (or the method name in a file referencing the service) and a call pattern as a usage. Review flagged usages in the report if in doubt.
